// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  microsoftId String   @unique
  email       String
  name        String?
  avatarUrl   String?
  isAdmin     Boolean  @default(false)
  language    String   @default("de")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLoginAt DateTime @default(now())

  // Microsoft OAuth tokens for email integration
  msAccessToken  String?   // Microsoft access token for Graph API
  msRefreshToken String?   // Microsoft refresh token
  msTokenExpiry  DateTime? // Token expiration time

  // Relations
  tasks           Task[]
  columns         Column[]
  tags            Tag[]
  pinColumns      PinColumn[]
  notes           Note[]
  preferences     UserPreferences?
  viewState       ViewState?
  calendarSources CalendarSource[]
  events          CalendarEvent[]
  recurrenceRules RecurrenceRule[]
  checklistItems  ChecklistItem[]
  kanbanBoards    KanbanBoard[]

  @@index([microsoftId])
  @@index([email])
}

model Task {
  id             String    @id @default(cuid())
  externalId     String?   // Original ID from client for sync
  userId         String
  title          String
  description    String?
  completed      Boolean   @default(false)
  priority       String    @default("none") // none, low, medium, high
  estimatedTime  Int? // minutes
  trackedTime    Int? // minutes
  tags           String[] // array of tag names
  subtasks       Json      @default("[]") // Subtask[]
  columnId       String?
  projectId      String?
  kanbanColumnId String?
  pinColumnId    String?
  pinned         Boolean   @default(false)
  reminderDate   String? // ISO date
  reminderTime   String? // HH:mm
  dueDate        String? // ISO date
  position       BigInt
  archived       Boolean   @default(false)
  completedAt    DateTime?
  linkedNotes    String[]  @default([])

  // Recurring task fields
  recurrenceRuleId String?
  parentSeriesId   String?
  isSeriesTemplate Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([columnId])
  @@index([projectId])
  @@index([archived])
  @@index([completed])
}

model Column {
  id          String   @id @default(cuid())
  externalId  String?  // Original ID from client for sync
  userId      String
  title       String
  type        String // "date" or "project"
  date        String? // ISO date for date columns
  order       Int
  linkedNotes String[] @default([])
  timebudget  Json? // ProjectTimebudget for projects
  color       String? // Project color for visual identification

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
}

model Tag {
  id         String   @id @default(cuid())
  externalId String?  // Original ID from client for sync
  userId     String
  name       String
  color      String?
  count      Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
}

model PinColumn {
  id         String   @id @default(cuid())
  externalId String?  // Original ID from client for sync
  userId     String
  title      String
  color      String?
  order      Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Note {
  id             String   @id @default(cuid())
  externalId     String?  // Original ID from client for sync
  userId         String
  title          String
  content        String   @default("")
  tags           String[] @default([])
  linkedTasks    String[] @default([])
  linkedNotes    String[] @default([])
  linkedProjects String[] @default([])
  pinned         Boolean  @default(false)
  archived       Boolean  @default(false)
  dailyNote      Boolean  @default(false)
  dailyNoteDate  String? // YYYY-MM-DD

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([archived])
  @@index([dailyNote])
}

model UserPreferences {
  id          String @id @default(cuid())
  userId      String @unique
  preferences Json // Full UserPreferences object

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ViewState {
  id     String @id @default(cuid())
  userId String @unique
  state  Json // Full ViewState + ProjectKanbanState

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CalendarSource {
  id       String    @id @default(cuid())
  userId   String
  name     String
  url      String
  color    String    @default("#3b82f6")
  enabled  Boolean   @default(true)
  lastSync DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CalendarEvent {
  id           String    @id @default(cuid())
  externalId   String?   // Original ID from client for sync
  userId       String
  calendarUrl  String
  uid          String
  title        String
  description  String?
  location     String?
  startTime    DateTime
  endTime      DateTime?
  allDay       Boolean   @default(false)
  status       String?
  recurrence   String?
  lastModified DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, uid])
  @@index([userId])
  @@index([startTime])
}

model RecurrenceRule {
  id         String   @id @default(cuid())
  externalId String?  // Original ID from client for sync
  userId     String
  pattern    Json // RecurrencePattern
  interval   Int
  endConfig  Json // RecurrenceEnd
  weekdays   String[] @default([])
  monthDay   Int?
  exceptions String[] @default([])
  isActive   Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ChecklistItem {
  id           String  @id @default(cuid())
  externalId   String? // Original ID from client for sync
  userId       String
  text         String
  completed    Boolean @default(false)
  reminderDate String?
  reminderTime String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model KanbanBoard {
  id           String @id @default(cuid())
  externalId   String? // Original ID from client for sync
  userId       String
  name         String
  description  String?
  groupingMode String @default("status")
  columns      Json   @default("[]") // KanbanColumnConfig[]
  isDefault    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// AI Settings - Singleton for instance-wide AI configuration
model AiSettings {
  id        String   @id @default("global") // Singleton pattern
  provider  String   @default("nebius")
  apiKey    String   // Encrypted with AES-256-GCM
  model     String   @default("Qwen/Qwen3-235B-A22B-Instruct-2507")
  enabled   Boolean  @default(true) // Enabled by default
  baseUrl   String   @default("https://api.studio.nebius.com/v1")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

